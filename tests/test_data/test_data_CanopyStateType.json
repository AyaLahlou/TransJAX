{
  "function_name": "canopy_state_management",
  "test_cases": [
    {
      "name": "test_init_allocate_single_patch_with_nan",
      "function": "init_allocate",
      "inputs": {
        "begp": 0,
        "endp": 0,
        "use_nan": true
      },
      "expected_output": {
        "shape": "(1,)",
        "all_nan": true
      },
      "metadata": {
        "type": "nominal",
        "description": "Initialize single patch with NaN values (Fortran default behavior)",
        "edge_cases": [
          "single_patch",
          "nan_initialization"
        ]
      }
    },
    {
      "name": "test_init_allocate_multiple_patches_with_zeros",
      "function": "init_allocate",
      "inputs": {
        "begp": 5,
        "endp": 14,
        "use_nan": false
      },
      "expected_output": {
        "shape": "(10,)",
        "all_zeros": true
      },
      "metadata": {
        "type": "nominal",
        "description": "Initialize 10 patches with zero values",
        "edge_cases": []
      }
    },
    {
      "name": "test_init_allocate_boundary_indices",
      "function": "init_allocate",
      "inputs": {
        "begp": 0,
        "endp": 0,
        "use_nan": false
      },
      "expected_output": {
        "shape": "(1,)",
        "all_zeros": true
      },
      "metadata": {
        "type": "edge",
        "description": "Test minimum valid patch range (begp == endp)",
        "edge_cases": [
          "minimum_range",
          "zero_index"
        ]
      }
    },
    {
      "name": "test_init_allocate_large_domain",
      "function": "init_allocate",
      "inputs": {
        "begp": 0,
        "endp": 9999,
        "use_nan": true
      },
      "expected_output": {
        "shape": "(10000,)",
        "all_nan": true
      },
      "metadata": {
        "type": "edge",
        "description": "Test large domain with 10000 patches",
        "edge_cases": [
          "large_domain"
        ]
      }
    },
    {
      "name": "test_init_allocate_from_bounds_typical",
      "function": "init_allocate_from_bounds",
      "inputs": {
        "bounds": {
          "begp": 10,
          "endp": 49,
          "begc": 5,
          "endc": 24,
          "begg": 0,
          "endg": 9
        },
        "use_nan": false
      },
      "expected_output": {
        "shape": "(40,)",
        "all_zeros": true
      },
      "metadata": {
        "type": "nominal",
        "description": "Initialize from Bounds object with typical domain decomposition",
        "edge_cases": []
      }
    },
    {
      "name": "test_create_canopy_state_small_domain",
      "function": "create_canopy_state",
      "inputs": {
        "n_patches": 1,
        "use_zeros": true
      },
      "expected_output": {
        "shape": "(1,)",
        "all_zeros": true
      },
      "metadata": {
        "type": "edge",
        "description": "Create state for minimum valid domain (1 patch)",
        "edge_cases": [
          "minimum_patches"
        ]
      }
    },
    {
      "name": "test_create_canopy_state_medium_domain_with_nan",
      "function": "create_canopy_state",
      "inputs": {
        "n_patches": 100,
        "use_zeros": false
      },
      "expected_output": {
        "shape": "(100,)",
        "all_nan": true
      },
      "metadata": {
        "type": "nominal",
        "description": "Create state for 100 patches initialized with NaN",
        "edge_cases": []
      }
    },
    {
      "name": "test_update_canopy_state_partial_update",
      "function": "update_canopy_state",
      "inputs": {
        "state": {
          "frac_veg_nosno_patch": [
            1.0,
            1.0,
            0.0,
            1.0,
            0.0
          ],
          "elai_patch": [
            3.5,
            4.2,
            0.0,
            2.8,
            0.0
          ],
          "esai_patch": [
            0.5,
            0.8,
            0.0,
            0.3,
            0.0
          ],
          "htop_patch": [
            15.0,
            18.5,
            0.0,
            12.3,
            0.0
          ]
        },
        "updates": {
          "elai_patch": [
            3.5,
            4.2,
            1.5,
            2.8,
            0.5
          ],
          "frac_veg_nosno_patch": [
            1.0,
            1.0,
            1.0,
            1.0,
            1.0
          ]
        }
      },
      "expected_output": {
        "frac_veg_nosno_patch": [
          1.0,
          1.0,
          1.0,
          1.0,
          1.0
        ],
        "elai_patch": [
          3.5,
          4.2,
          1.5,
          2.8,
          0.5
        ],
        "esai_patch": [
          0.5,
          0.8,
          0.0,
          0.3,
          0.0
        ],
        "htop_patch": [
          15.0,
          18.5,
          0.0,
          12.3,
          0.0
        ]
      },
      "metadata": {
        "type": "nominal",
        "description": "Update subset of fields (snow melting scenario - vegetation becoming exposed)",
        "edge_cases": []
      }
    },
    {
      "name": "test_update_canopy_state_extreme_values",
      "function": "update_canopy_state",
      "inputs": {
        "state": {
          "frac_veg_nosno_patch": [
            0.0,
            0.0,
            0.0
          ],
          "elai_patch": [
            0.0,
            0.0,
            0.0
          ],
          "esai_patch": [
            0.0,
            0.0,
            0.0
          ],
          "htop_patch": [
            0.0,
            0.0,
            0.0
          ]
        },
        "updates": {
          "frac_veg_nosno_patch": [
            1.0,
            1.0,
            1.0
          ],
          "elai_patch": [
            12.0,
            8.5,
            10.2
          ],
          "esai_patch": [
            2.5,
            1.8,
            2.1
          ],
          "htop_patch": [
            45.0,
            35.2,
            40.8
          ]
        }
      },
      "expected_output": {
        "frac_veg_nosno_patch": [
          1.0,
          1.0,
          1.0
        ],
        "elai_patch": [
          12.0,
          8.5,
          10.2
        ],
        "esai_patch": [
          2.5,
          1.8,
          2.1
        ],
        "htop_patch": [
          45.0,
          35.2,
          40.8
        ]
      },
      "metadata": {
        "type": "edge",
        "description": "Update from all zeros to high LAI/SAI values (dense forest canopy)",
        "edge_cases": [
          "zero_to_maximum",
          "dense_canopy"
        ]
      }
    },
    {
      "name": "test_validate_canopy_state_valid_mixed",
      "function": "validate_canopy_state",
      "inputs": {
        "state": {
          "frac_veg_nosno_patch": [
            1.0,
            0.0,
            1.0,
            1.0,
            0.0,
            1.0,
            0.0,
            1.0
          ],
          "elai_patch": [
            4.5,
            0.0,
            2.3,
            6.8,
            0.0,
            3.2,
            0.0,
            5.1
          ],
          "esai_patch": [
            0.8,
            0.0,
            0.4,
            1.2,
            0.0,
            0.6,
            0.0,
            0.9
          ],
          "htop_patch": [
            20.0,
            0.0,
            12.5,
            28.3,
            0.0,
            16.7,
            0.0,
            24.1
          ]
        }
      },
      "expected_output": {
        "valid": true
      },
      "metadata": {
        "type": "nominal",
        "description": "Validate state with mixed snow-covered and exposed vegetation patches",
        "edge_cases": []
      }
    },
    {
      "name": "test_validate_canopy_state_boundary_values",
      "function": "validate_canopy_state",
      "inputs": {
        "state": {
          "frac_veg_nosno_patch": [
            0.0,
            1.0,
            0.0,
            1.0
          ],
          "elai_patch": [
            0.0,
            0.001,
            0.0,
            15.0
          ],
          "esai_patch": [
            0.0,
            0.0001,
            0.0,
            3.0
          ],
          "htop_patch": [
            0.0,
            0.01,
            0.0,
            100.0
          ]
        }
      },
      "expected_output": {
        "valid": true
      },
      "metadata": {
        "type": "edge",
        "description": "Validate state with boundary values (very small and very large)",
        "edge_cases": [
          "minimum_nonzero",
          "maximum_realistic",
          "exact_zeros"
        ]
      }
    },
    {
      "name": "test_validate_canopy_state_all_zeros",
      "function": "validate_canopy_state",
      "inputs": {
        "state": {
          "frac_veg_nosno_patch": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "elai_patch": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "esai_patch": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ],
          "htop_patch": [
            0.0,
            0.0,
            0.0,
            0.0,
            0.0
          ]
        }
      },
      "expected_output": {
        "valid": true
      },
      "metadata": {
        "type": "edge",
        "description": "Validate state with all zeros (complete snow burial scenario)",
        "edge_cases": [
          "all_zeros",
          "complete_snow_cover"
        ]
      }
    },
    {
      "name": "test_init_allocate_from_bounds_single_patch",
      "function": "init_allocate_from_bounds",
      "inputs": {
        "bounds": {
          "begp": 0,
          "endp": 0,
          "begc": 0,
          "endc": 0,
          "begg": 0,
          "endg": 0
        },
        "use_nan": true
      },
      "expected_output": {
        "shape": "(1,)",
        "all_nan": true
      },
      "metadata": {
        "type": "edge",
        "description": "Initialize from Bounds with single patch/column/grid (minimum domain)",
        "edge_cases": [
          "minimum_domain",
          "all_indices_zero"
        ]
      }
    },
    {
      "name": "test_update_canopy_state_grassland_to_forest",
      "function": "update_canopy_state",
      "inputs": {
        "state": {
          "frac_veg_nosno_patch": [
            1.0,
            1.0,
            1.0,
            1.0
          ],
          "elai_patch": [
            0.5,
            0.8,
            0.6,
            0.7
          ],
          "esai_patch": [
            0.1,
            0.15,
            0.12,
            0.13
          ],
          "htop_patch": [
            0.3,
            0.5,
            0.4,
            0.45
          ]
        },
        "updates": {
          "elai_patch": [
            5.5,
            6.2,
            4.8,
            5.9
          ],
          "esai_patch": [
            1.2,
            1.5,
            1.0,
            1.3
          ],
          "htop_patch": [
            25.0,
            30.0,
            22.0,
            28.0
          ]
        }
      },
      "expected_output": {
        "frac_veg_nosno_patch": [
          1.0,
          1.0,
          1.0,
          1.0
        ],
        "elai_patch": [
          5.5,
          6.2,
          4.8,
          5.9
        ],
        "esai_patch": [
          1.2,
          1.5,
          1.0,
          1.3
        ],
        "htop_patch": [
          25.0,
          30.0,
          22.0,
          28.0
        ]
      },
      "metadata": {
        "type": "special",
        "description": "Simulate vegetation succession from grassland to forest (realistic ecological transition)",
        "edge_cases": []
      }
    }
  ],
  "notes": "Test data generation strategy:\n\n1. **Index constraints**: All begp/endp values satisfy begp >= 0 and endp >= begp. Array sizes computed as (endp - begp + 1).\n\n2. **Physical realism**:\n   - frac_veg_nosno_patch: Binary values (0.0 or 1.0) representing snow-free vegetation fraction\n   - elai_patch: Range [0.0, 15.0] covering bare ground to dense forest canopy\n   - esai_patch: Range [0.0, 3.0] representing stem area index\n   - htop_patch: Range [0.0, 100.0] meters for canopy height\n\n3. **Ecological scenarios**:\n   - Complete snow burial: All values = 0.0\n   - Partial snow cover: Mixed 0.0 and 1.0 for frac_veg_nosno_patch\n   - Grassland: Low LAI (0.5-1.0), low height (0.3-0.5m)\n   - Forest: High LAI (4.0-12.0), tall canopy (15-45m)\n   - Dense canopy: LAI > 8.0, height > 30m\n\n4. **Edge cases covered**:\n   - Single patch domains (n=1)\n   - Large domains (n=10000)\n   - Zero initialization vs NaN initialization\n   - All-zero states (complete snow cover)\n   - Boundary values (0.0, very small positive, very large)\n   - Minimum and maximum realistic values\n\n5. **Test distribution**:\n   - Nominal cases (50%): Tests 1, 2, 5, 7, 8, 10\n   - Edge cases (30%): Tests 3, 4, 6, 11, 12, 13\n   - Special cases (20%): Test 9, 14\n\n6. **Consistency**: All arrays within each test case have matching dimensions. Updates preserve immutability (return new state).\n\n7. **Validation tests**: Include physically valid states that should pass validation, covering the full range of expected conditions from bare ground to dense forest, with and without snow cover."
}